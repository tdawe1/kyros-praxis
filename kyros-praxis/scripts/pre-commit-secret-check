#!/bin/bash

# Pre-commit hook to prevent committing secrets

# Check for common secret patterns
SECRET_PATTERNS=(
    "SECRET_KEY.*[a-zA-Z0-9]"
    "NEXTAUTH_SECRET.*[a-zA-Z0-9]"
    "CSRF_SECRET.*[a-zA-Z0-9]"
    "POSTGRES_PASSWORD.*[a-zA-Z0-9]"
    "REDIS_PASSWORD.*[a-zA-Z0-9]"
    "QDRANT_API_KEY.*[a-zA-Z0-9]"
)

# Check staged files for secrets
STAGED_FILES=$(git diff --cached --name-only)

for file in $STAGED_FILES; do
    # Skip .env.example files
    if [[ $file == *.env.example ]]; then
        continue
    fi
    
    # Check if file contains secrets
    for pattern in "${SECRET_PATTERNS[@]}"; do
        if grep -q "$pattern" "$file" 2>/dev/null; then
            echo "ERROR: Potential secret found in $file"
            echo "Pattern matched: $pattern"
            echo "Please remove secrets before committing."
            echo "Consider using .env files instead."
            exit 1
        fi
    done
done

# Check for .env files being committed
if echo "$STAGED_FILES" | grep -q "\.env$"; then
    echo "ERROR: .env files should not be committed to version control"
    echo "Please use .env.example files instead and add .env to .gitignore"
    exit 1
fi

echo "Pre-commit check passed"
exit 0